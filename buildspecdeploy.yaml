version: 0.2

env:
  variables:
    PEM_BUCKET: test-key-file-upload                # âœ… Replace with your actual PEM S3 bucket name
    PEM_KEY: deploy-javaApp.pem                     # âœ… PEM key stored in S3
    S3_BUCKET: test-war-file-upload                 # âœ… S3 bucket that contains the .war file
    S3_KEY: build-artifacts/Ecomm.war               # âœ… .war file path inside S3
    EC2_USER: ec2-user                               # âœ… Default user for Amazon Linux
    EC2_HOST: ec2-54-236-5-156.compute-1.amazonaws.com  # âœ… EC2 public DNS

phases:
  install:
    runtime-versions:
      java: corretto11
    commands:
      - echo "ğŸ”§ Installing tools..."
      - yum install -y unzip awscli openssh

  pre_build:
    commands:
      - echo "ğŸ” Downloading PEM key from S3..."
      - aws s3 cp s3://$PEM_BUCKET/$PEM_KEY ec2-key.pem
      - chmod 400 ec2-key.pem

  build:
    commands:
      - echo "â¬‡ï¸ Downloading WAR from S3..."
      - aws s3 cp s3://$S3_BUCKET/$S3_KEY Ecomm.war

      - echo "ğŸš€ Copying WAR to EC2..."
      - scp -o StrictHostKeyChecking=no -i ec2-key.pem Ecomm.war $EC2_USER@$EC2_HOST:/home/ec2-user/

      - echo "ğŸ› ï¸ Installing Tomcat and deploying WAR on EC2..."
      - |
        ssh -o StrictHostKeyChecking=no -i ec2-key.pem $EC2_USER@$EC2_HOST <<'EOF'
        set -e  # Exit on any error

        # Install Java and wget
        sudo yum install -y java-11-openjdk wget

        # Setup Tomcat directory
        sudo mkdir -p /opt/tomcat
        cd /opt/tomcat

        # Download and extract Tomcat
        sudo wget https://downloads.apache.org/tomcat/tomcat-10/v10.1.42/bin/apache-tomcat-10.1.42.tar.gz
        sudo tar -xvzf apache-tomcat-10.1.42.tar.gz
        sudo mv apache-tomcat-10.1.42 tomcat
        sudo rm apache-tomcat-10.1.42.tar.gz

        # Move WAR file
        sudo mv /home/ec2-user/Ecomm.war /opt/tomcat/tomcat/webapps/

        # Make scripts executable
        sudo chmod +x /opt/tomcat/tomcat/bin/*.sh

        # Start Tomcat
        sudo /opt/tomcat/tomcat/bin/shutdown.sh || true
        sudo /opt/tomcat/tomcat/bin/startup.sh

        # Check Tomcat port
        sudo netstat -tuln | grep 8080 || echo "âŒ Port 8080 not listening"
        EOF

  post_build:
    commands:
      - echo "âœ… Tomcat deployment completed successfully."

artifacts:
  files:
    - Ecomm.war
