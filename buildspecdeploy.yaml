version: 0.2

env:
  variables:
    PEM_BUCKET: test-key-file-upload
    PEM_KEY: deploy-javaApp.pem
    S3_BUCKET: test-war-file-upload
    S3_KEY: build-artifacts/Ecomm.war
    EC2_USER: ec2-user
    EC2_HOST: ec2-54-236-5-156.compute-1.amazonaws.com

phases:
  install:
    runtime-versions:
      java: corretto11
    commands:
      - echo "ğŸ”§ Installing dependencies..."
      - yum install -y unzip awscli openssh

  pre_build:
    commands:
      - echo "ğŸ” Downloading PEM key from S3..."
      - aws s3 cp s3://$PEM_BUCKET/$PEM_KEY ec2-key.pem
      - chmod 400 ec2-key.pem

  build:
    commands:
      - echo "ğŸ“¦ Downloading WAR from S3..."
      - aws s3 cp s3://$S3_BUCKET/$S3_KEY Ecomm.war

      - echo "ğŸšš Copying WAR to EC2..."
      - scp -o StrictHostKeyChecking=no -i ec2-key.pem Ecomm.war $EC2_USER@$EC2_HOST:/home/ec2-user/

      - echo "ğŸ› ï¸ Installing Tomcat and deploying WAR on EC2..."
      - |
        ssh -o StrictHostKeyChecking=no -i ec2-key.pem $EC2_USER@$EC2_HOST 'bash -s' <<'ENDSSH'
        set -e

        echo "ğŸ”§ Installing Java and wget..."
        sudo yum install -y java-11-openjdk wget

        echo "ğŸ“ Creating Tomcat directory..."
        sudo mkdir -p /opt/tomcat
        cd /opt/tomcat

        echo "â¬‡ï¸ Downloading Tomcat..."
        sudo wget https://downloads.apache.org/tomcat/tomcat-10/v10.1.42/bin/apache-tomcat-10.1.42.tar.gz

        echo "ğŸ“¦ Extracting Tomcat..."
        sudo tar -xvzf apache-tomcat-10.1.42.tar.gz
        sudo mv apache-tomcat-10.1.42 tomcat
        sudo rm apache-tomcat-10.1.42.tar.gz

        echo "ğŸš€ Deploying WAR..."
        sudo mv /home/ec2-user/Ecomm.war /opt/tomcat/tomcat/webapps/

        echo "ğŸ”§ Setting JAVA_HOME for Tomcat..."
        JAVA_PATH=$(readlink -f $(which java) | sed "s:bin/java::")
        echo "export JAVA_HOME=$JAVA_PATH" | sudo tee -a /etc/profile
        export JAVA_HOME=$JAVA_PATH

        echo "ğŸ›ï¸ Starting Tomcat..."
        sudo chmod +x /opt/tomcat/tomcat/bin/*.sh
        sudo /opt/tomcat/tomcat/bin/shutdown.sh || true
        sudo /opt/tomcat/tomcat/bin/startup.sh

        echo "ğŸ“¡ Verifying Tomcat is running on port 8080..."
        sudo netstat -tuln | grep 8080 && echo "âœ… Tomcat is listening on port 8080"
        ENDSSH

  post_build:
    commands:
      - echo "âœ… Tomcat deployment completed successfully."

artifacts:
  files:
    - Ecomm.war
